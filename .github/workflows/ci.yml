stages: [build, test, sast]

sast:java:
  stage: sast
  image: maven:3.9.7-eclipse-temurin-21
  variables:
    MAVEN_OPTS: "-Dmaven.wagon.httpconnectionManager.ttlSeconds=25 -Dhttp.keepAlive=false"
    DC_DATA_DIR: ".m2/dependency-check-data"
  cache:
    key: "${CI_PROJECT_PATH}-m2"
    paths:
      - .m2/repository
      - .m2/dependency-check-data
  before_script:
    - mkdir -p .m2/dependency-check-data
  script:
    - mvn -B -DskipTests -DdataDirectory=$DC_DATA_DIR ${NVD_API_KEY:+-DnvdApiKey=$NVD_API_KEY} clean verify
  artifacts:
    when: always
    paths:
      - "**/target/spotbugsXml.xml"
      - "**/target/dependency-check-report.html"
      - "**/target/dependency-check-report.json"
    expire_in: 7 days
  allow_failure: false
  rules:
    - exists:
        - pom.xml
